{"ast":null,"code":"/**\n * @fileOverview\n * @author Laura Lindzey - lindzey@gmail.com\n */\nvar Topic = require('../core/Topic');\n\nvar Message = require('../core/Message');\n\nvar EventEmitter2 = require('eventemitter2').EventEmitter2;\n/**\n * An actionlib action server client.\n *\n * Emits the following events:\n *  * 'goal' - goal sent by action client\n *  * 'cancel' - action client has canceled the request\n *\n *  @constructor\n *  @param options - object with following keys:\n *   * ros - the ROSLIB.Ros connection handle\n *   * serverName - the action server name, like /fibonacci\n *   * actionName - the action message name, like 'actionlib_tutorials/FibonacciAction'\n */\n\n\nfunction SimpleActionServer(options) {\n  var that = this;\n  options = options || {};\n  this.ros = options.ros;\n  this.serverName = options.serverName;\n  this.actionName = options.actionName; // create and advertise publishers\n\n  this.feedbackPublisher = new Topic({\n    ros: this.ros,\n    name: this.serverName + '/feedback',\n    messageType: this.actionName + 'Feedback'\n  });\n  this.feedbackPublisher.advertise();\n  var statusPublisher = new Topic({\n    ros: this.ros,\n    name: this.serverName + '/status',\n    messageType: 'actionlib_msgs/GoalStatusArray'\n  });\n  statusPublisher.advertise();\n  this.resultPublisher = new Topic({\n    ros: this.ros,\n    name: this.serverName + '/result',\n    messageType: this.actionName + 'Result'\n  });\n  this.resultPublisher.advertise(); // create and subscribe to listeners\n\n  var goalListener = new Topic({\n    ros: this.ros,\n    name: this.serverName + '/goal',\n    messageType: this.actionName + 'Goal'\n  });\n  var cancelListener = new Topic({\n    ros: this.ros,\n    name: this.serverName + '/cancel',\n    messageType: 'actionlib_msgs/GoalID'\n  }); // Track the goals and their status in order to publish status...\n\n  this.statusMessage = new Message({\n    header: {\n      stamp: {\n        secs: 0,\n        nsecs: 100\n      },\n      frame_id: ''\n    },\n    status_list: []\n  }); // needed for handling preemption prompted by a new goal being received\n\n  this.currentGoal = null; // currently tracked goal\n\n  this.nextGoal = null; // the one that'll be preempting\n\n  goalListener.subscribe(function (goalMessage) {\n    if (that.currentGoal) {\n      that.nextGoal = goalMessage; // needs to happen AFTER rest is set up\n\n      that.emit('cancel');\n    } else {\n      that.statusMessage.status_list = [{\n        goal_id: goalMessage.goal_id,\n        status: 1\n      }];\n      that.currentGoal = goalMessage;\n      that.emit('goal', goalMessage.goal);\n    }\n  }); // helper function for determing ordering of timestamps\n  // returns t1 < t2\n\n  var isEarlier = function (t1, t2) {\n    if (t1.secs > t2.secs) {\n      return false;\n    } else if (t1.secs < t2.secs) {\n      return true;\n    } else if (t1.nsecs < t2.nsecs) {\n      return true;\n    } else {\n      return false;\n    }\n  }; // TODO: this may be more complicated than necessary, since I'm\n  // not sure if the callbacks can ever wind up with a scenario\n  // where we've been preempted by a next goal, it hasn't finished\n  // processing, and then we get a cancel message\n\n\n  cancelListener.subscribe(function (cancelMessage) {\n    // cancel ALL goals if both empty\n    if (cancelMessage.stamp.secs === 0 && cancelMessage.stamp.secs === 0 && cancelMessage.id === '') {\n      that.nextGoal = null;\n\n      if (that.currentGoal) {\n        that.emit('cancel');\n      }\n    } else {\n      // treat id and stamp independently\n      if (that.currentGoal && cancelMessage.id === that.currentGoal.goal_id.id) {\n        that.emit('cancel');\n      } else if (that.nextGoal && cancelMessage.id === that.nextGoal.goal_id.id) {\n        that.nextGoal = null;\n      }\n\n      if (that.nextGoal && isEarlier(that.nextGoal.goal_id.stamp, cancelMessage.stamp)) {\n        that.nextGoal = null;\n      }\n\n      if (that.currentGoal && isEarlier(that.currentGoal.goal_id.stamp, cancelMessage.stamp)) {\n        that.emit('cancel');\n      }\n    }\n  }); // publish status at pseudo-fixed rate; required for clients to know they've connected\n\n  var statusInterval = setInterval(function () {\n    var currentTime = new Date();\n    var secs = Math.floor(currentTime.getTime() / 1000);\n    var nsecs = Math.round(1000000000 * (currentTime.getTime() / 1000 - secs));\n    that.statusMessage.header.stamp.secs = secs;\n    that.statusMessage.header.stamp.nsecs = nsecs;\n    statusPublisher.publish(that.statusMessage);\n  }, 500); // publish every 500ms\n}\n\nSimpleActionServer.prototype.__proto__ = EventEmitter2.prototype;\n/**\n*  Set action state to succeeded and return to client\n*/\n\nSimpleActionServer.prototype.setSucceeded = function (result2) {\n  var resultMessage = new Message({\n    status: {\n      goal_id: this.currentGoal.goal_id,\n      status: 3\n    },\n    result: result2\n  });\n  this.resultPublisher.publish(resultMessage);\n  this.statusMessage.status_list = [];\n\n  if (this.nextGoal) {\n    this.currentGoal = this.nextGoal;\n    this.nextGoal = null;\n    this.emit('goal', this.currentGoal.goal);\n  } else {\n    this.currentGoal = null;\n  }\n};\n/**\n*  Set action state to aborted and return to client\n*/\n\n\nSimpleActionServer.prototype.setAborted = function (result2) {\n  var resultMessage = new Message({\n    status: {\n      goal_id: this.currentGoal.goal_id,\n      status: 4\n    },\n    result: result2\n  });\n  this.resultPublisher.publish(resultMessage);\n  this.statusMessage.status_list = [];\n\n  if (this.nextGoal) {\n    this.currentGoal = this.nextGoal;\n    this.nextGoal = null;\n    this.emit('goal', this.currentGoal.goal);\n  } else {\n    this.currentGoal = null;\n  }\n};\n/**\n*  Function to send feedback\n*/\n\n\nSimpleActionServer.prototype.sendFeedback = function (feedback2) {\n  var feedbackMessage = new Message({\n    status: {\n      goal_id: this.currentGoal.goal_id,\n      status: 1\n    },\n    feedback: feedback2\n  });\n  this.feedbackPublisher.publish(feedbackMessage);\n};\n/**\n*  Handle case where client requests preemption\n*/\n\n\nSimpleActionServer.prototype.setPreempted = function () {\n  this.statusMessage.status_list = [];\n  var resultMessage = new Message({\n    status: {\n      goal_id: this.currentGoal.goal_id,\n      status: 2\n    }\n  });\n  this.resultPublisher.publish(resultMessage);\n\n  if (this.nextGoal) {\n    this.currentGoal = this.nextGoal;\n    this.nextGoal = null;\n    this.emit('goal', this.currentGoal.goal);\n  } else {\n    this.currentGoal = null;\n  }\n};\n\nmodule.exports = SimpleActionServer;","map":{"version":3,"sources":["/Users/julien/Sites/react-ros-robot/node_modules/roslib/src/actionlib/SimpleActionServer.js"],"names":["Topic","require","Message","EventEmitter2","SimpleActionServer","options","that","ros","serverName","actionName","feedbackPublisher","name","messageType","advertise","statusPublisher","resultPublisher","goalListener","cancelListener","statusMessage","header","stamp","secs","nsecs","frame_id","status_list","currentGoal","nextGoal","subscribe","goalMessage","emit","goal_id","status","goal","isEarlier","t1","t2","cancelMessage","id","statusInterval","setInterval","currentTime","Date","Math","floor","getTime","round","publish","prototype","__proto__","setSucceeded","result2","resultMessage","result","setAborted","sendFeedback","feedback2","feedbackMessage","feedback","setPreempted","module","exports"],"mappings":"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","sourcesContent":["/**\n * @fileOverview\n * @author Laura Lindzey - lindzey@gmail.com\n */\n\nvar Topic = require('../core/Topic');\nvar Message = require('../core/Message');\nvar EventEmitter2 = require('eventemitter2').EventEmitter2;\n\n/**\n * An actionlib action server client.\n *\n * Emits the following events:\n *  * 'goal' - goal sent by action client\n *  * 'cancel' - action client has canceled the request\n *\n *  @constructor\n *  @param options - object with following keys:\n *   * ros - the ROSLIB.Ros connection handle\n *   * serverName - the action server name, like /fibonacci\n *   * actionName - the action message name, like 'actionlib_tutorials/FibonacciAction'\n */\n\nfunction SimpleActionServer(options) {\n    var that = this;\n    options = options || {};\n    this.ros = options.ros;\n    this.serverName = options.serverName;\n    this.actionName = options.actionName;\n\n    // create and advertise publishers\n    this.feedbackPublisher = new Topic({\n        ros : this.ros,\n        name : this.serverName + '/feedback',\n        messageType : this.actionName + 'Feedback'\n    });\n    this.feedbackPublisher.advertise();\n\n    var statusPublisher = new Topic({\n        ros : this.ros,\n        name : this.serverName + '/status',\n        messageType : 'actionlib_msgs/GoalStatusArray'\n    });\n    statusPublisher.advertise();\n\n    this.resultPublisher = new Topic({\n        ros : this.ros,\n        name : this.serverName + '/result',\n        messageType : this.actionName + 'Result'\n    });\n    this.resultPublisher.advertise();\n\n    // create and subscribe to listeners\n    var goalListener = new Topic({\n        ros : this.ros,\n        name : this.serverName + '/goal',\n        messageType : this.actionName + 'Goal'\n    });\n\n    var cancelListener = new Topic({\n        ros : this.ros,\n        name : this.serverName + '/cancel',\n        messageType : 'actionlib_msgs/GoalID'\n    });\n\n    // Track the goals and their status in order to publish status...\n    this.statusMessage = new Message({\n        header : {\n            stamp : {secs : 0, nsecs : 100},\n            frame_id : ''\n        },\n        status_list : []\n    });\n\n    // needed for handling preemption prompted by a new goal being received\n    this.currentGoal = null; // currently tracked goal\n    this.nextGoal = null; // the one that'll be preempting\n\n    goalListener.subscribe(function(goalMessage) {\n        \n    if(that.currentGoal) {\n            that.nextGoal = goalMessage;\n            // needs to happen AFTER rest is set up\n            that.emit('cancel');\n    } else {\n            that.statusMessage.status_list = [{goal_id : goalMessage.goal_id, status : 1}];\n            that.currentGoal = goalMessage;\n            that.emit('goal', goalMessage.goal);\n    }\n    });\n\n    // helper function for determing ordering of timestamps\n    // returns t1 < t2\n    var isEarlier = function(t1, t2) {\n        if(t1.secs > t2.secs) {\n            return false;\n        } else if(t1.secs < t2.secs) {\n            return true;\n        } else if(t1.nsecs < t2.nsecs) {\n            return true;\n        } else {\n            return false;\n        }\n    };\n\n    // TODO: this may be more complicated than necessary, since I'm\n    // not sure if the callbacks can ever wind up with a scenario\n    // where we've been preempted by a next goal, it hasn't finished\n    // processing, and then we get a cancel message\n    cancelListener.subscribe(function(cancelMessage) {\n\n        // cancel ALL goals if both empty\n        if(cancelMessage.stamp.secs === 0 && cancelMessage.stamp.secs === 0 && cancelMessage.id === '') {\n            that.nextGoal = null;\n            if(that.currentGoal) {\n                that.emit('cancel');\n            }\n        } else { // treat id and stamp independently\n            if(that.currentGoal && cancelMessage.id === that.currentGoal.goal_id.id) {\n                that.emit('cancel');\n            } else if(that.nextGoal && cancelMessage.id === that.nextGoal.goal_id.id) {\n                that.nextGoal = null;\n            }\n\n            if(that.nextGoal && isEarlier(that.nextGoal.goal_id.stamp,\n                                          cancelMessage.stamp)) {\n                that.nextGoal = null;\n            }\n            if(that.currentGoal && isEarlier(that.currentGoal.goal_id.stamp,\n                                             cancelMessage.stamp)) {\n                \n                that.emit('cancel');\n            }\n        }\n    });\n\n    // publish status at pseudo-fixed rate; required for clients to know they've connected\n    var statusInterval = setInterval( function() {\n        var currentTime = new Date();\n        var secs = Math.floor(currentTime.getTime()/1000);\n        var nsecs = Math.round(1000000000*(currentTime.getTime()/1000-secs));\n        that.statusMessage.header.stamp.secs = secs;\n        that.statusMessage.header.stamp.nsecs = nsecs;\n        statusPublisher.publish(that.statusMessage);\n    }, 500); // publish every 500ms\n\n}\n\nSimpleActionServer.prototype.__proto__ = EventEmitter2.prototype;\n\n/**\n*  Set action state to succeeded and return to client\n*/\n\nSimpleActionServer.prototype.setSucceeded = function(result2) {\n    \n\n    var resultMessage = new Message({\n        status : {goal_id : this.currentGoal.goal_id, status : 3},\n        result : result2\n    });\n    this.resultPublisher.publish(resultMessage);\n\n    this.statusMessage.status_list = [];\n    if(this.nextGoal) {\n        this.currentGoal = this.nextGoal;\n        this.nextGoal = null;\n        this.emit('goal', this.currentGoal.goal);\n    } else {\n        this.currentGoal = null;\n    }\n};\n\n/**\n*  Set action state to aborted and return to client\n*/\n\nSimpleActionServer.prototype.setAborted = function(result2) {\n    var resultMessage = new Message({\n        status : {goal_id : this.currentGoal.goal_id, status : 4},\n        result : result2\n    });\n    this.resultPublisher.publish(resultMessage);\n\n    this.statusMessage.status_list = [];\n    if(this.nextGoal) {\n        this.currentGoal = this.nextGoal;\n        this.nextGoal = null;\n        this.emit('goal', this.currentGoal.goal);\n    } else {\n        this.currentGoal = null;\n    }\n};\n\n/**\n*  Function to send feedback\n*/\n\nSimpleActionServer.prototype.sendFeedback = function(feedback2) {\n\n    var feedbackMessage = new Message({\n        status : {goal_id : this.currentGoal.goal_id, status : 1},\n        feedback : feedback2\n    });\n    this.feedbackPublisher.publish(feedbackMessage);\n};\n\n/**\n*  Handle case where client requests preemption\n*/\n\nSimpleActionServer.prototype.setPreempted = function() {\n\n    this.statusMessage.status_list = [];\n    var resultMessage = new Message({\n        status : {goal_id : this.currentGoal.goal_id, status : 2},\n    });\n    this.resultPublisher.publish(resultMessage);\n\n    if(this.nextGoal) {\n        this.currentGoal = this.nextGoal;\n        this.nextGoal = null;\n        this.emit('goal', this.currentGoal.goal);\n    } else {\n        this.currentGoal = null;\n    }\n};\n\nmodule.exports = SimpleActionServer;"]},"metadata":{},"sourceType":"script"}